# TickTick MCP Server コード品質改善計画

## 概要

コードベースを調査した結果、全体的にSOLID原則に沿った良好な構造でしたが、いくつかのコード重複が発見されました。この計画では、最小限の変更で重複を排除し、保守性を向上させます。

## 発見された問題

### 高優先度: コードの完全重複
- `getAllTasks()` 関数: `tasks-query.ts:8-17` と `tasks-gtd.ts:8-17` で完全一致
- `startOfDayUTC()` 関数: `tasks-query.ts:20-24` と `tasks-gtd.ts:19-23` で完全一致
- `startOfNextDayUTC()` 関数: `tasks-query.ts:27-35` と `tasks-gtd.ts:25-33` で完全一致

### 見送り項目
- MCP レスポンス形式のヘルパー化 (変更箇所多、効果小)
- 型定義のリテラル型化 (TickTick API の仕様が不明確)

## 実装計画

### Step 1: 共通ユーティリティファイル作成

**新規作成**: `src/tools/task-utils.ts`

```typescript
import type { TickTickClient } from "../ticktick/client.js";
import type { Task } from "../ticktick/types.js";

export async function getAllTasks(client: TickTickClient): Promise<Task[]> {
  const projects = await client.getProjects();
  const allTasks: Task[] = [];
  for (const project of projects) {
    if (project.closed) continue;
    const data = await client.getProjectWithData(project.id);
    allTasks.push(...data.tasks);
  }
  return allTasks;
}

export function startOfDayUTC(date: Date): Date {
  return new Date(
    Date.UTC(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate()),
  );
}

export function startOfNextDayUTC(date: Date): Date {
  return new Date(
    Date.UTC(
      date.getUTCFullYear(),
      date.getUTCMonth(),
      date.getUTCDate() + 1,
    ),
  );
}
```

### Step 2: tasks-query.ts の修正

**ファイル**: `src/tools/tasks-query.ts`

変更内容:
1. import に `getAllTasks`, `startOfDayUTC`, `startOfNextDayUTC` を追加
2. ローカル定義の3関数を削除 (行 8-35)
3. `isDueOnDate`, `isDueInRange`, `isOverdue`, `filterTasks` は維持

### Step 3: tasks-gtd.ts の修正

**ファイル**: `src/tools/tasks-gtd.ts`

変更内容:
1. import に `getAllTasks`, `startOfDayUTC`, `startOfNextDayUTC` を追加
2. ローカル定義の3関数を削除 (行 8-33)

### Step 4: テストファイル作成

**新規作成**: `test/task-utils.test.ts`

```typescript
import { describe, it, expect } from "vitest";
import { startOfDayUTC, startOfNextDayUTC } from "../src/tools/task-utils.js";

describe("startOfDayUTC", () => {
  it("returns midnight UTC for given date", () => {
    const date = new Date("2024-03-15T14:30:00Z");
    const result = startOfDayUTC(date);
    expect(result.toISOString()).toBe("2024-03-15T00:00:00.000Z");
  });
});

describe("startOfNextDayUTC", () => {
  it("returns midnight UTC of next day", () => {
    const date = new Date("2024-03-15T14:30:00Z");
    const result = startOfNextDayUTC(date);
    expect(result.toISOString()).toBe("2024-03-16T00:00:00.000Z");
  });
});
```

## 修正対象ファイル

| ファイル | 変更種別 |
|----------|----------|
| `src/tools/task-utils.ts` | 新規作成 |
| `src/tools/tasks-query.ts` | 修正 |
| `src/tools/tasks-gtd.ts` | 修正 |
| `test/task-utils.test.ts` | 新規作成 |

## 検証方法

```bash
# 1. 型チェック
npx tsc -p tsconfig.json --noEmit

# 2. テスト実行
npm test

# 3. 開発サーバーで動作確認
npm run dev
```

## リスクと対策

| リスク | 対策 |
|--------|------|
| import パスのミス | ESM では `.js` 拡張子必須、型チェックで検出 |
| 関数シグネチャの不一致 | 完全一致を確認済み |
| 循環依存 | `task-utils.ts` は types.ts と client.ts にのみ依存 |

## 期待される効果

- **削除コード**: 約40行
- **追加コード**: 約25行
- **純減**: 約15行
- 保守性向上: 同一ロジックの一元管理
